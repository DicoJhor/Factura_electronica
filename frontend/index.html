<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Facturador Beta (Monol√≠tico)</title>
    
    <!-- Carga de Tailwind CSS CDN para usar las clases de estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuraci√≥n de Tailwind para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Fuente Inter (Tu fuente base) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet"
    />

    <!-- Estilos base para el cuerpo -->
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #eef2f7); 
            color: #111827;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #root {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Carga de React y ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!--
        INICIO DEL C√ìDIGO DE LA APLICACI√ìN REACT
    -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // URL del backend en Railway
        const API_URL = 'https://facturaelectronica-production.up.railway.app';

        // --- 1. L√ìGICA DE UTILIDAD Y HOOKS ---

        // Funci√≥n auxiliar para formatear la moneda (Soles Peruanos)
        const formatCurrency = (amount) => {
            const value = typeof amount === 'number' ? amount : 0;
            // Usamos 'es-PE' y 'PEN' para Soles Peruanos
            return new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(value);
        };

        // Componente Modal de Mensajes (Reemplazo de alert())
        const MessageBox = ({ message, type, onClose }) => {
            if (!message) return null;
            
            const baseClasses = "fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-50 z-50";
            const contentClasses = "bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100";
            const textClasses = type === 'error' ? 'text-red-600 font-bold' : 'text-green-600 font-bold';
            const icon = type === 'error' ? 
                <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-red-500 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg> :
                <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-green-500 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>;

            return (
                <div className={baseClasses} onClick={onClose}>
                    <div className={contentClasses} onClick={e => e.stopPropagation()}>
                        <div className="flex items-center mb-4">
                            {icon}
                            <p className={`text-lg ${textClasses}`}>{type === 'error' ? 'Error' : '√âxito'}</p>
                        </div>
                        {/* Removemos el prefijo del mensaje (‚ùå o ‚úÖ) para mostrar solo el texto limpio */}
                        <p className="mb-6 text-gray-700">{message.replace(/^(‚úÖ|‚ùå)\s*/, '')}</p> 
                        <button 
                            onClick={onClose} 
                            className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition shadow-md"
                        >
                            Aceptar
                        </button>
                    </div>
                </div>
            );
        };

        // Componente para los items de la barra de navegaci√≥n
        const NavItem = ({ label, active, onClick }) => (
            <button
                onClick={onClick}
                className={`
                    px-3 py-2 rounded-lg text-sm font-medium transition-colors duration-200
                    ${active 
                        ? 'bg-indigo-900 text-white shadow-md' 
                        : 'text-indigo-200 hover:bg-indigo-600 hover:text-white'
                    }
                `}
            >
                {label}
            </button>
        );

        // Componente de la Barra de Navegaci√≥n (Navbar)
        const Navbar = ({ currentPage, setCurrentPage }) => (
            <nav className="bg-indigo-700 shadow-lg">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between h-16">
                        <div className="flex items-center">
                            <span className="text-xl font-bold text-white tracking-wider">FACTURACI√ìN APP</span>
                        </div>
                        {/* Reemplazamos los Links del router por NavItems que actualizan el estado */}
                        <div className="flex space-x-4 items-center">
                            <NavItem 
                                label="Cat√°logo (Inicio)" 
                                active={currentPage === 'productos'}
                                onClick={() => setCurrentPage('productos')}
                            />
                            <NavItem 
                                label="Emitir Comprobante" 
                                active={currentPage === 'comprobante'}
                                onClick={() => setCurrentPage('comprobante')}
                            />
                            <NavItem 
                                label="Ver Facturas" 
                                active={currentPage === 'facturas'}
                                onClick={() => setCurrentPage('facturas')}
                            />
                        </div>
                    </div>
                </div>
            </nav>
        );

        // --- 2. VISTAS DE P√ÅGINA (PAGES) ---

        // Vista de Cat√°logo (ProductosList)
        const ProductosListView = ({ isProductLoading, productosDisponibles }) => {
            return (
                <div className="p-4">
                    <h2 className="text-3xl font-extrabold text-indigo-800 mb-6 border-b-4 border-indigo-100 pb-3">
                        üì¶ Cat√°logo de Productos
                    </h2>

                    {isProductLoading ? (
                        <div className="text-center py-10 text-indigo-500">
                            <svg className="animate-spin h-6 w-6 mr-3 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Cargando cat√°logo...
                        </div>
                    ) : productosDisponibles.length === 0 ? (
                        <div className="text-center py-10 text-red-500 italic border-2 border-dashed border-red-200 rounded-xl bg-red-50">
                            No se encontraron productos. Verifica la conexi√≥n a tu backend.
                        </div>
                    ) : (
                        <div className="overflow-x-auto bg-white rounded-xl">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-indigo-600">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider rounded-tl-xl">Nombre</th>
                                        <th className="px-6 py-3 text-right text-xs font-bold text-white uppercase tracking-wider">Precio</th>
                                        <th className="px-6 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Stock</th>
                                        <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider rounded-tr-xl">Categor√≠a</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                    {productosDisponibles.map((p) => (
                                        <tr key={p.id} className="hover:bg-indigo-50 transition duration-150">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{p.nombre}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">{formatCurrency(p.precio)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.stock > 10 ? 'bg-green-100 text-green-800' : p.stock > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                    {p.stock}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.categoria}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Vista de Comprobante (ComprobanteFormView)
        const ComprobanteForm = ({ 
            cliente, handleClienteChange, productosDisponibles, isProductLoading,
            productosSeleccionados, agregarProducto, eliminarProducto, cambiarCantidad,
            total, loading, emitirComprobante, facturaGenerada
        }) => {
            return (
                <div className="p-4">
                    <h2 className="text-3xl font-extrabold text-indigo-800 mb-6 border-b-4 border-indigo-100 pb-3 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 9a1 1 0 000 2h10a1 1 0 100-2H5z" clipRule="evenodd" />
                            <path fillRule="evenodd" d="M10 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1z" clipRule="evenodd" />
                        </svg>
                        Emisi√≥n de Comprobante Electr√≥nico
                    </h2>

                    {/* 1. Datos del Cliente */}
                    <div className="mb-8 p-4 border border-indigo-200 bg-indigo-50 rounded-xl shadow-inner">
                        <h3 className="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM2 8a2 2 0 114 0 2 2 0 01-4 0zM1 18v-3a4 4 0 014-4h14a4 4 0 014 4v3h-22z" />
                            </svg>
                            Informaci√≥n del Cliente
                        </h3>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <input
                                type="text"
                                name="nombre"
                                placeholder="Nombre / Raz√≥n Social"
                                value={cliente.nombre}
                                onChange={handleClienteChange}
                                className="p-3 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-sm"
                            />
                            <input
                                type="text"
                                name="ruc"
                                placeholder="RUC o DNI"
                                value={cliente.ruc}
                                onChange={handleClienteChange}
                                className="p-3 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-sm"
                            />
                            <input
                                type="text"
                                name="direccion"
                                placeholder="Direcci√≥n Completa (Opcional)"
                                value={cliente.direccion}
                                onChange={handleClienteChange}
                                className="p-3 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-sm sm:col-span-1"
                            />
                        </div>
                    </div>

                    {/* 2. Selecci√≥n de productos */}
                    <div className="mb-8">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                            Seleccionar Productos
                        </h3>
                        
                        {isProductLoading ? (
                            <div className="text-center py-5 text-indigo-500">
                                <svg className="animate-spin h-5 w-5 mr-3 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Cargando cat√°logo...
                            </div>
                        ) : productosDisponibles.length === 0 ? (
                            <div className="text-center py-5 text-red-500 italic border-2 border-dashed border-red-200 rounded-lg">
                                No se encontraron productos o hay un error de conexi√≥n con el backend.
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                {productosDisponibles.map((prod) => (
                                    <button
                                        key={prod.id}
                                        onClick={() => agregarProducto(prod)}
                                        disabled={prod.stock !== undefined && prod.stock <= 0} 
                                        title={prod.stock !== undefined && prod.stock <= 0 ? "Sin Stock" : "A√±adir a la lista"}
                                        className={`
                                            rounded-xl p-3 text-sm font-semibold text-center transition-all duration-200 transform hover:scale-[1.03] shadow-md
                                            ${prod.stock !== undefined && prod.stock <= 0
                                                ? "bg-gray-200 border border-gray-300 text-gray-500 cursor-not-allowed opacity-70"
                                                : "bg-white border border-green-300 text-green-700 hover:bg-green-50"
                                            }
                                        `}
                                    >
                                        {prod.nombre} <br />
                                        <span className="text-xs font-normal mt-1 block">
                                            {formatCurrency(prod.precio)}
                                            {prod.stock !== undefined && (
                                                <span className="ml-2 text-gray-500">| Stock: {prod.stock}</span>
                                            )}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* 3. Productos seleccionados y Total */}
                    <div className="mb-8">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                            Detalle del Comprobante
                        </h3>
                        
                        {productosSeleccionados.length === 0 ? (
                            <div className="text-center py-5 text-gray-500 italic border-2 border-dashed border-gray-200 rounded-lg">
                                A√∫n no ha agregado productos. Haga clic en el cat√°logo superior para empezar.
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden shadow-lg">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Producto</th>
                                            <th className="px-6 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-24">Cantidad</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-24">Precio U.</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-24">Subtotal</th>
                                            <th className="px-6 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-24">Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-100">
                                        {productosSeleccionados.map((p) => (
                                            <tr key={p.id} className="hover:bg-gray-50 transition duration-150">
                                                <td className="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{p.nombre}</td>
                                                <td className="px-6 py-3 text-center">
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        max={p.stockMax}
                                                        value={p.cantidad}
                                                        onChange={(e) => cambiarCantidad(p.id, e.target.value)}
                                                        className="border border-gray-300 rounded-md p-1 w-20 text-center text-sm focus:ring-indigo-500 focus:border-indigo-500"
                                                    />
                                                </td>
                                                <td className="px-6 py-3 text-right whitespace-nowrap text-sm text-gray-700">{formatCurrency(p.precio)}</td>
                                                <td className="px-6 py-3 text-right whitespace-nowrap text-sm font-bold text-gray-800">{formatCurrency(p.cantidad * p.precio)}</td>
                                                <td className="px-6 py-3 text-center">
                                                    <button
                                                        onClick={() => eliminarProducto(p.id)}
                                                        className="text-red-600 hover:text-red-900 transition-colors duration-150 p-2 rounded-full hover:bg-red-100"
                                                        title="Eliminar producto"
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clipRule="evenodd" />
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr className="bg-indigo-50 border-t-2 border-indigo-200">
                                            <td colSpan="3" className="px-6 py-3 text-right text-base font-bold text-indigo-800">TOTAL:</td>
                                            <td className="px-6 py-3 text-lg font-extrabold text-indigo-800 text-right">{formatCurrency(total)}</td>
                                            <td className="px-6 py-3"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        )}
                    </div>

                    {/* 4. Bot√≥n de Env√≠o y Resultado */}
                    <div className="flex justify-between items-center pt-4 border-t border-gray-200">
                        <button
                            onClick={emitirComprobante}
                            disabled={loading || productosSeleccionados.length === 0 || !cliente.nombre || !cliente.ruc}
                            className={`
                                rounded-xl px-6 py-3 font-bold text-lg transition-all duration-300 transform hover:scale-[1.02] shadow-xl flex items-center gap-3
                                ${loading ? "bg-gray-400 text-gray-600 cursor-not-allowed" : "bg-green-600 hover:bg-green-700 text-white"}
                            `}
                        >
                            {loading ? (
                                <>
                                    <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Generando Comprobante...
                                </>
                            ) : (
                                <>
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1h2V3a1 1 0 00-1-1zm3 0h2v2H9V2zm3 0h2v2h-2V2zM4 6a1 1 0 00-1 1v2h2V7a1 1 0 00-1-1zm12 0a1 1 0 011 1v2h-2V7a1 1 0 011-1zM3 11v2h2v-2H3zm14 0v2h-2v-2h2zm-14 3v2a1 1 0 001 1h2v-2H3zm12 0v2h-2v-2h2zm-3 0v2H9v-2h2zm-3 0v2H6v-2h2z" clipRule="evenodd" />
                                    </svg>
                                    Emitir Comprobante
                                </>
                            )}
                        </button>

                        {facturaGenerada && (
                            <div className="flex gap-2">
                                <a
                                    href={`${API_URL}${facturaGenerada.pdf}`} 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="bg-blue-600 text-white font-semibold px-4 py-2.5 rounded-xl hover:bg-blue-700 transition-shadow shadow-lg flex items-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" />
                                    </svg>
                                    Ver PDF
                                </a>
                                <a
                                    href={`${API_URL}${facturaGenerada.pdf}`}
                                    download
                                    className="bg-green-600 text-white font-semibold px-4 py-2.5 rounded-xl hover:bg-green-700 transition-shadow shadow-lg flex items-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                                    </svg>
                                    Descargar
                                </a>
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // Vista de Facturas (FacturasList)
        const FacturasList = ({ alert }) => {
            const [facturas, setFacturas] = useState([]);
            const [loading, setLoading] = useState(true);

            const memoizedAlert = useCallback(alert, [alert]); 

            useEffect(() => {
                const fetchFacturas = async () => {
                    setLoading(true);
                    try {
                        // Endpoint para obtener facturas existentes
                        const res = await fetch(`${API_URL}/api/facturas`); 
                        if (!res.ok) throw new Error("Error al cargar facturas.");
                        const data = await res.json();
                        setFacturas(data);
                    } catch (error) {
                        console.error("Error fetching invoices:", error);
                        memoizedAlert("‚ùå Error de conexi√≥n: No se pudo cargar la lista de facturas.");
                        setFacturas([]);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchFacturas();
            }, [memoizedAlert]); 

            return (
                <div className="p-4">
                    <h2 className="text-3xl font-extrabold text-indigo-800 mb-6 border-b-4 border-indigo-100 pb-3">
                        üßæ Historial de Facturas
                    </h2>

                    {loading ? (
                        <div className="text-center py-10 text-indigo-500">
                            <svg className="animate-spin h-6 w-6 mr-3 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Cargando facturas...
                        </div>
                    ) : facturas.length === 0 ? (
                        <div className="text-center py-10 text-gray-500 italic border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                            A√∫n no hay facturas generadas.
                        </div>
                    ) : (
                        <div className="overflow-x-auto bg-white rounded-xl">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-indigo-600">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider rounded-tl-xl">ID Factura</th>
                                        <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Cliente</th>
                                        <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">RUC/DNI</th>
                                        <th className="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Fecha</th>
                                        <th className="px-6 py-3 text-right text-xs font-bold text-white uppercase tracking-wider">Total</th>
                                        <th className="px-6 py-3 text-center text-xs font-bold text-white uppercase tracking-wider rounded-tr-xl">PDF</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                    {facturas.map((f, index) => (
                                        <tr key={index} className="hover:bg-indigo-50 transition duration-150">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{f.id || `FACT-${index + 1}`}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{f.cliente_nombre || "‚Äî"}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{f.cliente_documento || "‚Äî"}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                                {f.fecha_emision ? new Date(f.fecha_emision).toLocaleDateString("es-PE") : "‚Äî"}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 text-right">{formatCurrency(f.total)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-center">
                                                {f.pdf ? (
                                                    <a
                                                        href={`${API_URL}${f.pdf}`} 
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="text-indigo-600 hover:text-indigo-800 font-semibold"
                                                    >
                                                        Ver PDF
                                                    </a>
                                                ) : 'N/A'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };


        // Componente L√≥gico para ComprobanteForm (contiene la l√≥gica de estados y API)
        const ComprobanteFormLogic = ({ productosDisponibles, isProductLoading, alert }) => {
            const [cliente, setCliente] = useState({ nombre: "", ruc: "", direccion: "" });
            const [productosSeleccionados, setProductosSeleccionados] = useState([]);
            const [facturaGenerada, setFacturaGenerada] = useState(null);
            const [loading, setLoading] = useState(false);

            // C√°lculo del total como valor derivado
            const total = useMemo(() => {
                return productosSeleccionados.reduce((acc, p) => 
                    acc + (Number(p.cantidad) || 0) * (Number(p.precio) || 0), 0
                );
            }, [productosSeleccionados]);


            // Actualiza los datos del cliente
            const handleClienteChange = (e) => {
                const { name, value } = e.target;
                setCliente((prev) => ({ ...prev, [name]: value }));
            };
            
            // Agregar producto seleccionado a la lista
            const agregarProducto = (producto) => {
                const yaExiste = productosSeleccionados.find((p) => p.id === producto.id);
                
                if (yaExiste) {
                    const nuevos = productosSeleccionados.map((p) =>
                        p.id === producto.id ? { ...p, cantidad: p.cantidad + 1 } : p
                    );
                    setProductosSeleccionados(nuevos);
                } else {
                    const nuevos = [...productosSeleccionados, { ...producto, cantidad: 1, stockMax: 1000 }];
                    setProductosSeleccionados(nuevos);
                }
            };

            // Eliminar producto de la lista
            const eliminarProducto = (id) => {
                const nuevos = productosSeleccionados.filter((p) => p.id !== id);
                setProductosSeleccionados(nuevos);
            };

            // Actualizar cantidad
            const cambiarCantidad = (id, cantidadStr) => {
                const cantidad = Number(cantidadStr);
                if (cantidad < 1 || isNaN(cantidad)) return;

                const nuevos = productosSeleccionados.map((p) =>
                    p.id === id ? { ...p, cantidad: cantidad } : p
                );
                setProductosSeleccionados(nuevos);
            };

            // Emitir comprobante (env√≠o al backend)
            const emitirComprobante = async () => {
                if (!cliente.nombre || !cliente.ruc) {
                    alert("‚ùå Por favor, completa los campos Nombre/Raz√≥n Social y RUC/DNI.");
                    return;
                }

                if (productosSeleccionados.length === 0) {
                    alert("‚ùå Debe agregar al menos un producto para emitir el comprobante.");
                    return;
                }

                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/api/facturas`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            cliente,
                            detalles: productosSeleccionados.map((p) => ({
                                producto: p.nombre,
                                cantidad: p.cantidad,
                                precio_unitario: p.precio,
                                subtotal: p.cantidad * p.precio, 
                            })),
                            total,
                        }),
                    });

                    const data = await res.json();

                    if (res.ok) {
                        console.log("Respuesta del servidor:", data);
                        alert("‚úÖ Factura generada correctamente. Haz clic en 'Ver PDF Generado'.");
                        setFacturaGenerada(data);
                    } else {
                        alert("‚ùå Error al generar la factura: " + (data.error || "Error desconocido del servidor."));
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("‚ùå No se pudo conectar con el servidor para emitir el comprobante.");
                } finally {
                    setLoading(false);
                }
            };
            
            // Renderiza la vista del formulario
            return <ComprobanteForm 
                cliente={cliente} 
                handleClienteChange={handleClienteChange} 
                productosDisponibles={productosDisponibles} 
                isProductLoading={isProductLoading}
                productosSeleccionados={productosSeleccionados} 
                agregarProducto={agregarProducto} 
                eliminarProducto={eliminarProducto} 
                cambiarCantidad={cambiarCantidad}
                total={total} 
                loading={loading} 
                emitirComprobante={emitirComprobante} 
                facturaGenerada={facturaGenerada} 
            />
        }


        // --- 3. COMPONENTE PRINCIPAL (APP) CON L√ìGICA DE NAVEGACI√ìN Y ESTADO DE DATOS ---

        function App() {
            // Estado para simular el router: 'productos' es la ruta por defecto (/)
            const [currentPage, setCurrentPage] = useState('productos'); 
            
            // Estados de datos compartidos (Cat√°logo)
            const [productosDisponibles, setProductosDisponibles] = useState([]);
            const [isProductLoading, setIsProductLoading] = useState(true);
            
            // Estado para el modal de mensajes
            const [message, setMessage] = useState(null);
            
            const alert = useCallback((msg) => {
                setMessage({ msg, type: msg.startsWith('‚ùå') ? 'error' : 'success' });
            }, [setMessage]); 
            const closeMessage = () => setMessage(null);
            
            // Funci√≥n para cargar productos
            const fetchProductos = useCallback(async () => {
                setIsProductLoading(true);
                try {
                    const res = await fetch(`${API_URL}/api/productos`);
                    
                    if (!res.ok) {
                        throw new Error("Respuesta de red no fue ok.");
                    }
                    
                    const data = await res.json();
                    setProductosDisponibles(data);
                } catch (error) {
                    console.error("Error al obtener productos:", error);
                    alert("‚ùå Error de conexi√≥n: No se pudo cargar el cat√°logo de productos. Aseg√∫rate que tu servidor backend est√° corriendo.");
                } finally {
                    setIsProductLoading(false);
                }
            }, [alert, setIsProductLoading, setProductosDisponibles]);


            // Cargar productos desde el backend
            useEffect(() => {
                fetchProductos();
            }, [fetchProductos]);

            // Funci√≥n para renderizar la p√°gina actual
            const renderPage = () => {
                switch (currentPage) {
                    case 'comprobante':
                        return <ComprobanteFormLogic 
                            productosDisponibles={productosDisponibles} 
                            isProductLoading={isProductLoading}
                            alert={alert}
                        />;
                    case 'facturas':
                        return <FacturasList 
                            alert={alert}
                        />;
                    case 'productos':
                    default:
                        return <ProductosListView 
                            alert={alert}
                            isProductLoading={isProductLoading} 
                            productosDisponibles={productosDisponibles} 
                        />;
                }
            };
            
            return (
                <div className="min-h-screen flex flex-col">
                    <Navbar currentPage={currentPage} setCurrentPage={setCurrentPage} />
                    
                    <main className="flex-grow flex justify-center items-start px-4 sm:px-6 lg:px-8 py-8 md:py-12">
                        <div className="w-full max-w-7xl bg-white shadow-2xl rounded-xl p-6 lg:p-10 border border-gray-50">
                            {renderPage()}
                        </div>
                    </main>

                    <footer className="text-center text-sm text-gray-500 py-4 border-t border-gray-200 bg-white/70 backdrop-blur-sm shadow-inner">
                        ¬© {new Date().getFullYear()} Facturador Beta ‚Äî Todos los derechos reservados.
                    </footer>
                    
                    <MessageBox 
                        message={message?.msg} 
                        type={message?.type} 
                        onClose={closeMessage} 
                    />
                </div>
            );
        }

        // Renderizar la aplicaci√≥n en el DOM
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>
</html>